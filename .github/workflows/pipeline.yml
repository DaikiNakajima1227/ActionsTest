# This workflow will do a clean installation of node dependencies, cache/restore them, build the source code and run tests across different versions of node
# For more information see: https://docs.github.com/en/actions/automating-builds-and-tests/building-and-testing-nodejs

name: SFCC CI

on: [push]

jobs:
    prepare:
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v3
            - name: Use Node.js
              uses: actions/setup-node@v3
              with:
                  node-version: '12.x'
            - name: Install dependencies
              run: npm install
            - name: SonarQube Scan
              uses: sonarsource/sonarqube-scan-action@master
              env:
                SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
                SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}
                LC_ALL: "ja_JP.UTF-8"
            - name: unit test
              run: npm test
            - name: build
              env:
                SFCC_OAUTH_CLIENT_ID: ${{ secrets.SFCC_OAUTH_CLIENT_ID }}
                SFCC_OAUTH_CLIENT_SECRET: ${{ secrets.SFCC_OAUTH_CLIENT_SECRET }}
                SFCC_INSTANCE_URL: ${{ secrets.SFCC_INSTANCE_URL }}
              run: |
                # npm run build
                TIME_STAMP=`date '+%Y%m%d%H%M%S'`
                CODE_VERSION="release_gitactions_${TIME_STAMP}"
                PREV_DIR=`pwd`
                cd ..
                CUR_DIR=`pwd`
                ARCHIVE_PATH=${CUR_DIR}/${CODE_VERSION}
                cp -r "ActionsTest" ${ARCHIVE_PATH}
                echo `ls -l`
                zip -r ${CODE_VERSION} ${CODE_VERSION} 
                RETURN_CODE=$?
                if [ ${RETURN_CODE} -ne 0 ]; then
                    echo "圧縮処理に失敗しました。"
                    exit 1
                fi
                export CODE_VERSION
                export ARCHIVE_PATH
                cd ${PREV_DIR}
                # sh .circleci/scripts/archive.sh
                sh .github/workflows/scripts/deploy.sh
            
